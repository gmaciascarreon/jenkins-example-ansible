pipeline {
    agent any

    parameters {
        choice(
            name: 'ENV',
            choices: ['dev', 'test', 'prod'],
            description: 'Select environment for Ansible deployment'
        )
    }

    environment {
        // Default (will be replaced in Script block)
        ANSIBLE_PRIVATE_KEY = ""
    }

    stages {
        stage('Select Credentials') {
            steps {
                script {
                    // Choose SSH key based on selected ENV
                    if (params.ENV == 'dev') {
                        env.ANSIBLE_PRIVATE_KEY = credentials('mariadb-private-key-dev')
                    } else if (params.ENV == 'test') {
                        env.ANSIBLE_PRIVATE_KEY = credentials('mariadb-private-key-test')
                    } else if (params.ENV == 'prod') {
                        env.ANSIBLE_PRIVATE_KEY = credentials('mariadb-private-key-prod')
                    } else {
                        error("ENV parameter was not set. Aborting job.")
                    }

                    echo "Using SSH key credentials for environment: ${params.ENV}"
                }
            }
        }

        stage('Approval (Prod Only)') {
            when {
                expression { return params.ENV == 'prod' }
            }
            steps {
                script {
                    input message: "Are you sure you want to deploy to '${params.ENV}'?"
                }
            }
        }

        stage('Run Ansible') {
            steps {
                sh """
                    echo "Selected environment: \$ENV"
                    echo "Using private key at: \$ANSIBLE_PRIVATE_KEY"

                    sudo yum install -y python3

                    python3 -m venv ansible
                    source ansible/bin/activate

                    pip install --upgrade pip
                    pip install ansible

                    ansible-galaxy collection install -r requirements.yml

                    ansible-playbook -i inventory/${ENV}/mariadb.hosts --private-key=${ANSIBLE_PRIVATE_KEY} playbooks/mariadb.yml
                """
            }
        }
    }
}
