pipeline {
    agent any

    parameters {
        choice(
            name: 'ENV',
            choices: ['dev', 'test', 'prod'],
            description: 'Select environment for Ansible deployment'
        )
    }

    stages {

        stage('Run Ansible') {
            steps {
                script {

                    // Select SSH and License credentials
                    def sshCredId = ""
                    def licenseCredId = ""

                    if (params.ENV == 'dev') {
                        sshCredId = 'mariadb-private-key-dev'
                        licenseCredId = 'dcv_trial_license_dev'
                    } else if (params.ENV == 'test') {
                        sshCredId = 'mariadb-private-key-test'
                        licenseCredId = 'dcv_trial_license_test'
                    } else if (params.ENV == 'prod') {
                        sshCredId = 'mariadb-private-key-prod'
                        licenseCredId = 'dcv_trial_license_prod'
                    } else {
                        error("Invalid environment")
                    }

                    echo "Selected environment: ${params.ENV}"
                    echo "Using SSH credential: ${sshCredId}"
                    echo "Using License credential: ${licenseCredId}"

                    // Use BOTH credentials
                    withCredentials([
                        sshUserPrivateKey(
                            credentialsId: sshCredId,
                            keyFileVariable: 'SSH_KEY',
                            usernameVariable: 'SSH_USER'
                        ),
                        file(
                            credentialsId: licenseCredId,
                            variable: 'LICENSE_FILE'
                        )
                    ]) {

                        sh '''
                            echo "Using private key: $SSH_KEY"
                            echo "License temp file: $LICENSE_FILE"

                            sudo yum install -y python3

                            python3 -m venv ansible
                            source ansible/bin/activate

                            pip install --upgrade pip
                            pip install ansible

                            ansible-galaxy collection install -r requirements.yml

                            # Copy license to where the software needs it
                            #cp $LICENSE_FILE ./license.lic

                            #ls -l ./license.lic

                            ansible-playbook \
                                -i inventory/${ENV}/mariadb.hosts \
                                --private-key=$SSH_KEY \
                                --extra-vars "license_file=$LICENSE_FILE" \
                                playbooks/mariadb.yml
                        '''
                    }
                }
            }
        }
    }
}
