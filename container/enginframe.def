Bootstrap: docker
From: python:3.11-slim

%labels
    Author WalloMac
    Version v1.0

#%environment
%arguments 
#    # Default value (will be overridden by Jenkins)
     APP_ENV="dev"
#    export APP_ENV=$SIN_ENVIRONMENT
%setup
  mkdir ${APPTAINER_ROOTFS}/dist
  mkdir ${APPTAINER_ROOTFS}/ansible

%post
    export APP_ENV="${APPTAINER_ARG_APP_ENV}"
    dnf install -y python3 glibc-common
    echo ">>> Installing Python..."
    pip install --no-cache-dir --upgrade pip    
    python3 -m venv /opt/ansible
    source /opt/ansible/bin/activate
    pip install ansible
    export LC_ALL=C.UTF-8
    cd /ansible
    ansible-playbook -i inventory/${APP_ENV}/mariadb.hosts container.yml
    

    mkdir -p /app
    cat << 'EOF' > /app/hello.py
import os
env = os.getenv("APP_ENV", "unknown")
print(f"Hello World! APP_ENV=${APP_ENV}")
EOF

%runscript
    # When running the container, this is executed
    python3 /app/hello.py
