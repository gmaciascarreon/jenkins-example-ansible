Bootstrap: docker
From: rockylinux:9

%labels
    Author WalloMac
    Version v1.0

%environment
#%arguments 
#    # Default value (will be overridden by Jenkins)
#     APP_ENV="dev"
export APP_ENV={{ APP_ENV }}
#    export APP_ENV=$SIN_ENVIRONMENT
%setup
  mkdir ${APPTAINER_ROOTFS}/dist
  mkdir ${APPTAINER_ROOTFS}/ansible

%post
    # ---- Detect correct variable name ----
    #if [ -n "${APPTAINER_ARG_APP_ENV}" ]; then
    #    export APP_ENV="${APPTAINER_ARG_APP_ENV}"
    #elif [ -n "${SINGULARITY_ARG_APP_ENV}" ]; then
    #    export APP_ENV="${SINGULARITY_ARG_APP_ENV}"
    #else
    #    echo "ERROR: APP_ENV argument not found!"
    #    exit 1
    #fi

    echo ">>> BUILD using APP_ENV={{ APP_ENV }}"


    dnf install -y python3 python3-pip glibc-common
    echo ">>> Installing Python..."
    python3 -m pip install --no-cache-dir --upgrade pip
    python3 -m venv /opt/ansible


    #pip install --no-cache-dir --upgrade pip    
    #python3 -m venv /opt/ansible
    source /opt/ansible/bin/activate
    pip install ansible
    export LC_ALL=C.UTF-8
    cd /ansible
    #ansible-playbook -i inventory/{{ APP_ENV }}/mariadb.hosts container.yml
    ansible-playbook -i localhost container.yml

    mkdir -p /app
    cat << 'EOF' > /app/hello.py
import os
env = os.getenv("APP_ENV", "unknown")
print(f"Hello World! APP_ENV=${APP_ENV}")
EOF

%runscript
    # When running the container, this is executed
    python3 /app/hello.py
